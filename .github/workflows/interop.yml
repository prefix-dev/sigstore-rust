name: Interoperability Tests

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  interop-v1:
    name: Interop Tests (Rekor V1)
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@1.89.0

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Build release binaries
        run: cargo build --release -p sigstore-sign -p sigstore-verify --examples

      - name: Create test artifact
        run: |
          echo "Hello from sigstore-rust interop test at $(date)" > test-artifact.txt
          sha256sum test-artifact.txt

      # =========================================
      # Test 1: Sign with sigstore-rust, verify with cosign
      # =========================================
      - name: "[V1] Sign with sigstore-rust"
        run: |
          ./target/release/examples/sign_blob test-artifact.txt -o rust-signed.sigstore.json
          echo "Bundle created:"
          cat rust-signed.sigstore.json | jq -r '.mediaType'

      - name: "[V1] Verify sigstore-rust signature with cosign"
        run: |
          cosign verify-blob \
            --bundle rust-signed.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact.txt
          echo "✅ Cosign successfully verified sigstore-rust signature (V1)"

      # =========================================
      # Test 2: Sign with sigstore-rust, verify with sigstore-rust
      # =========================================
      - name: "[V1] Verify sigstore-rust signature with sigstore-rust"
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact.txt rust-signed.sigstore.json
          echo "✅ sigstore-rust successfully verified its own signature (V1)"

      # =========================================
      # Test 3: Sign with cosign, verify with sigstore-rust
      # =========================================
      - name: "[V1] Sign with cosign"
        run: |
          cosign sign-blob \
            --yes \
            --bundle cosign-signed.sigstore.json \
            test-artifact.txt
          echo "Bundle created:"
          cat cosign-signed.sigstore.json | jq -r '.mediaType'

      - name: "[V1] Verify cosign signature with sigstore-rust"
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact.txt cosign-signed.sigstore.json
          echo "✅ sigstore-rust successfully verified cosign signature (V1)"

      # =========================================
      # Test 4: Cross-verify cosign signature with cosign (sanity check)
      # =========================================
      - name: "[V1] Verify cosign signature with cosign (sanity check)"
        run: |
          cosign verify-blob \
            --bundle cosign-signed.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact.txt
          echo "✅ Cosign successfully verified its own signature (V1)"

  interop-v2:
    name: Interop Tests (Rekor V2)
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@1.89.0

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Build release binaries
        run: cargo build --release -p sigstore-sign -p sigstore-verify --examples

      - name: Create test artifact
        run: |
          echo "Hello from sigstore-rust interop test V2 at $(date)" > test-artifact-v2.txt
          sha256sum test-artifact-v2.txt

      # =========================================
      # Test 1: Sign with sigstore-rust (V2), verify with cosign
      # =========================================
      - name: "[V2] Sign with sigstore-rust --v2"
        run: |
          ./target/release/examples/sign_blob --v2 test-artifact-v2.txt -o rust-signed-v2.sigstore.json
          echo "Bundle created:"
          cat rust-signed-v2.sigstore.json | jq -r '.mediaType'
          echo "Entry kind/version:"
          cat rust-signed-v2.sigstore.json | jq -r '.verificationMaterial.tlogEntries[0].kindVersion'

      - name: "[V2] Verify sigstore-rust V2 signature with cosign"
        run: |
          cosign verify-blob \
            --bundle rust-signed-v2.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact-v2.txt
          echo "✅ Cosign successfully verified sigstore-rust V2 signature"

      # =========================================
      # Test 2: Sign with sigstore-rust (V2), verify with sigstore-rust
      # =========================================
      - name: "[V2] Verify sigstore-rust V2 signature with sigstore-rust"
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact-v2.txt rust-signed-v2.sigstore.json
          echo "✅ sigstore-rust successfully verified its own V2 signature"

      # =========================================
      # Test 3: Sign with cosign (V2), verify with sigstore-rust
      # =========================================
      - name: "[V2] Sign with cosign --new-bundle-format"
        run: |
          # cosign uses --new-bundle-format for v0.3 bundles with Rekor v2
          cosign sign-blob \
            --yes \
            --new-bundle-format \
            --bundle cosign-signed-v2.sigstore.json \
            test-artifact-v2.txt
          echo "Bundle created:"
          cat cosign-signed-v2.sigstore.json | jq -r '.mediaType'

      - name: "[V2] Verify cosign V2 signature with sigstore-rust"
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact-v2.txt cosign-signed-v2.sigstore.json
          echo "✅ sigstore-rust successfully verified cosign V2 signature"

      # =========================================
      # Test 4: Cross-verify cosign V2 signature with cosign (sanity check)
      # =========================================
      - name: "[V2] Verify cosign V2 signature with cosign (sanity check)"
        run: |
          cosign verify-blob \
            --bundle cosign-signed-v2.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            test-artifact-v2.txt
          echo "✅ Cosign successfully verified its own V2 signature"

  interop-digest:
    name: Interop Tests (Digest-based verification)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@1.89.0

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Build release binaries
        run: cargo build --release -p sigstore-sign -p sigstore-verify --examples

      - name: Create test artifact and compute digest
        run: |
          echo "Digest-based verification test at $(date)" > digest-test.txt
          DIGEST=$(sha256sum digest-test.txt | cut -d' ' -f1)
          echo "ARTIFACT_DIGEST=sha256:${DIGEST}" >> $GITHUB_ENV
          echo "Artifact digest: sha256:${DIGEST}"

      # =========================================
      # Sign with sigstore-rust, verify with digest only
      # =========================================
      - name: Sign with sigstore-rust
        run: |
          ./target/release/examples/sign_blob digest-test.txt -o digest-bundle.sigstore.json

      - name: Verify with cosign using digest
        run: |
          cosign verify-blob \
            --bundle digest-bundle.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${{ env.ARTIFACT_DIGEST }}
          echo "✅ Cosign verified using digest"

      - name: Verify with sigstore-rust using digest
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${{ env.ARTIFACT_DIGEST }} digest-bundle.sigstore.json
          echo "✅ sigstore-rust verified using digest"

      # =========================================
      # Sign with cosign, verify with sigstore-rust using digest
      # =========================================
      - name: Sign with cosign
        run: |
          cosign sign-blob \
            --yes \
            --bundle cosign-digest-bundle.sigstore.json \
            digest-test.txt

      - name: Verify cosign bundle with sigstore-rust using digest
        run: |
          ./target/release/examples/verify_bundle \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${{ env.ARTIFACT_DIGEST }} cosign-digest-bundle.sigstore.json
          echo "✅ sigstore-rust verified cosign bundle using digest"

  interop-attestation:
    name: Interop Tests (Attestations / DSSE)
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@1.89.0

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Build release binaries
        run: cargo build --release -p sigstore-sign -p sigstore-verify --examples

      - name: Create test artifact
        run: |
          echo "Test package content for attestation at $(date)" > test-package.txt
          sha256sum test-package.txt

      # =========================================
      # Test 1: Attest with sigstore-rust, verify with cosign
      # =========================================
      - name: "[DSSE] Attest with sigstore-rust"
        run: |
          ./target/release/examples/sign_attestation \
            --channel "https://example.com/test-channel" \
            test-package.txt -o rust-attestation.sigstore.json
          echo "Attestation bundle created:"
          cat rust-attestation.sigstore.json | jq -r '.mediaType'
          echo "Entry kind:"
          cat rust-attestation.sigstore.json | jq -r '.verificationMaterial.tlogEntries[0].kindVersion.kind'

      - name: "[DSSE] Verify sigstore-rust attestation with cosign"
        run: |
          cosign verify-blob-attestation \
            --bundle rust-attestation.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --type "https://schemas.conda.org/attestations-publish-1.schema.json" \
            test-package.txt
          echo "✅ Cosign successfully verified sigstore-rust attestation"

      # =========================================
      # Test 2: Attest with sigstore-rust, verify with sigstore-rust
      # =========================================
      - name: "[DSSE] Verify sigstore-rust attestation with sigstore-rust"
        run: |
          ./target/release/examples/verify_conda_attestation \
            test-package.txt rust-attestation.sigstore.json
          echo "✅ sigstore-rust successfully verified its own attestation"

      # =========================================
      # Test 3: Attest with cosign, verify with sigstore-rust
      # =========================================
      - name: "[DSSE] Attest with cosign"
        run: |
          # Create an in-toto statement for cosign
          DIGEST=$(sha256sum test-package.txt | cut -d' ' -f1)
          cat > predicate.json << EOF
          {
            "targetChannel": "https://example.com/cosign-test-channel"
          }
          EOF

          cosign attest-blob \
            --yes \
            --bundle cosign-attestation.sigstore.json \
            --predicate predicate.json \
            --type "https://schemas.conda.org/attestations-publish-1.schema.json" \
            test-package.txt
          echo "Attestation bundle created:"
          cat cosign-attestation.sigstore.json | jq -r '.mediaType'

      - name: "[DSSE] Verify cosign attestation with sigstore-rust"
        run: |
          ./target/release/examples/verify_conda_attestation \
            test-package.txt cosign-attestation.sigstore.json
          echo "✅ sigstore-rust successfully verified cosign attestation"

      # =========================================
      # Test 4: Cross-verify cosign attestation with cosign (sanity check)
      # =========================================
      - name: "[DSSE] Verify cosign attestation with cosign (sanity check)"
        run: |
          cosign verify-blob-attestation \
            --bundle cosign-attestation.sigstore.json \
            --certificate-identity-regexp ".*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --type "https://schemas.conda.org/attestations-publish-1.schema.json" \
            test-package.txt
          echo "✅ Cosign successfully verified its own attestation"
